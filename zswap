#!/bin/bash

PARMS=/sys/module/zswap/parameters
SHARE=/usr/share/zswap

# In case of no translations use defaults:
Disabled="disabled"
NoRoot="Run me as superuser"
NoSwap="swap partition not found"
NotInUse="is not in use"
Zram="zram-swap is already in use"
Impossible="can't start"
Possible="while enabled"
Ratio="Compression ratio"

[ -f $SHARE/$LANG -a -s $SHARE/$LANG ] && { # check & use messages translation
	i18n=$SHARE/$LANG
	for W in Disabled Impossible NoRoot NoSwap NotInUse Possible Ratio Zram; do
		eval $W="\"`awk -F'\t' '/^'$W'/{print $NF}' $i18n`"\"
	done
}

[ $UID -eq 0 ] || { # run as root only
	echo "$NoRoot".
	exit 1
}

protect(){ # don't run if something's wrong
	unset MSG
	ZRAMS=`swapon | grep -c  zram`
	SWAPS=`swapon | grep -cv zram`
	[ $ZRAMS -le 0 ] || MSG="$Zram"
	[ $SWAPS -gt 0 ] || MSG="$NoSwap"
}

stats(){
	[ `cat $PARMS/enabled` == Y ] && {
		eval `grep -R . $PARMS /sys/kernel/debug/zswap | sed 's|.*/||;s|:|=|'`
		[ $pool_total_size -le 0 ] && {
			echo zswap "$NotInUse", "$Impossible"
		} || {
			for d in `ls -I *enabled /sys/module/zswap/parameters/` `ls /sys/kernel/debug/zswap`; do
				case $d in
					*size)	[ "$i18n" ] &&
								end=" `awk '/^byte/{print $2}' $i18n`" ||
								end=" bytes";;
					*percent)	end="%";;
					*)			end=
				esac
				[ "$i18n" ] &&
					TEXT="`awk -F'\t' '/^'$d'/{print $NF}' $i18n`" ||
					TEXT="`echo ${d^} | sed 's|_percent||;s|_| |g'`"
				echo "$TEXT": ${!d}$end
			done
			echo $Ratio: `bc<<<"scale=2;4096*$stored_pages/$pool_total_size"`
		}
		RETVAL=0
	} || {
		printf "zswap $Disabled"
		protect
		[ "$MSG" ] && {
			echo ", $Impossible: $MSG"
			exit 1
		}
		echo
		RETVAL=1
	}
}

reload(){ # Set preconfigured parameters if any
	local CFG=sysconfig
	case `lsb_release -a 2>&1 | awk '/Distributor ID/{print $3}'` in
		Debian|Ubuntu|Mint) CFG=default;;
	esac
	source /etc/$CFG/zswap
	for ARG in `ls -I *enabled $PARMS`; do
		[ "${!ARG}" ] && echo ${!ARG} >$PARMS/${ARG}
	done
	stats
	RETVAL=0
}

start(){
	protect
	[ "$MSG" ] && {
		echo "$MSG"
		exit 1
	}
	echo Y >$PARMS/enabled
	reload
	RETVAL=0
}

stop(){
	echo N >$PARMS/enabled
	RETVAL=0
}

restart(){
	stop
	start
}

case $1 in # switch zswap on/off
	1|Y|y|on|start) start;;
	0|N|n|off|stop) stop ;;
	restart|reload) $1   ;;
	*) stats
esac

exit $RETVAL
